<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>

    
    <!-- external css -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" href="favicon_io/favicon.ico">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" 
    crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="register.css"/>

    <!-- internal css -->
    <style>
       
    </style>
</head>
    <body>
        <!-- code for main form -->
        <main>
            <div class="background-container container-fluid position-absolute">
                <img class="img-fluid" id="moon-background" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/moon2.png" alt="">  
                <div class="stars z-n1 position-absolute"></div>
                <div class="twinkling z-n1 position-absolute"></div>
                <div class="clouds z-n1 position-absolute"></div>

                <!-- code for register form -->
                <div class="login_container">
                    <div id="add_new" class="container p-5 my-5">
                        <div class="container text-center">
                            <div class="row">
                                <h1 class="display-1 pb-3 text-black">Register</h1>
                            <div class="col d-flex justify-content-center align-items-center">
                                <div class="login_txtbox">
                                    <input id="login_username" required="required" type="text" maxlength="25">
                                    <span>Username</span>
                                    <i></i>
                                </div>
                            </div>
                            </div>
                            <p id="user_limit"></p>
                            <div class="row mt-2">
                                <div class="col d-flex justify-content-center align-items-center">
                                <div class="login_txtbox">
                                    <input id="login_password" required="required" type="password">
                                    <span>Password</span>
                                    <i></i>
                                    </label>
                                </div>
                                </div>
                            </div>

                            <div class="row mt-2">
                                <div class="col d-flex justify-content-center align-items-center">
                                    <div class="checkbox-wrapper-10">
                                        <input checked="" type="checkbox" id="show_pass" class="tgl tgl-flip">
                                        <label for="show_pass" data-tg-on="Show Password" data-tg-off="Hide Password" class="tgl-btn"></label>
                                    </div>
                                    
                                </div>
                            </div>

                            <div class="row mt-5">
                                <div class="col d-flex justify-content-center align-items-center">
                                <div class="login_txtbox">
                                    <button id="btn_register">
                                        Register
                                    </button>
                                </div>
                                </div>
                            </div>
                            <p class="pt-5 text-white">Already have an account? <a href="index.html" class=" link-body-emphasis link-offset-2 link-offset-3-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover">Sign In.</a></p>
                            <input class="invisible" id="accountId" type="number">
                        </div>
                    </div>
                </div>
                <!-- code for register form end -->
            </div>
        </main>
        <!-- code for main form end -->


        <!-- modal for success register -->
        <div class="modal fade ps-5" id="register_modal" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalToggleLabel"></h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="window.location.href='index.html'"></button>
                </div>
                <div class="modal-body text-center">
                    <p id="register_modal_p" class="pt-3">Successfully Registered.</p>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-toggle="modal" onclick="window.location.href='index.html'">Close</button>
                </div>
              </div>
            </div>
          </div>
          <!-- modal for success register end -->
        
        <!-- modal for username and password null values -->
        <div class="modal fade ps-5" id="user_pass_null_modal" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalToggleLabel"></h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p id="user_pass_null_modal_p" class="pt-3">Please type a username and password.</p>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
          <!-- modal for username and password null values end -->

          <!-- modal for username already taken -->
        <div class="modal fade ps-5" id="user_already_taken" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalToggleLabel"></h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p id="user_already_taken_modal_p" class="pt-3">This username already taken.</p>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
          <!-- modal for username already taken end -->


            <!-- modal for username length -->
        <div class="modal fade ps-5" id="username_lenght_modal" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalToggleLabel"></h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p id="username_lenght_modal_p" class="pt-3">Username length limit, 5 minimum and 25 maximum.</p>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
          <!-- modal for username length end -->

        <!-- Javascript -->
        <script>
            // code for show password
             let password = document.querySelector("#login_password");
             let showpass = document.querySelector("#show_pass");

             showpass.onchange = function(e)
             {
                password.type = showpass.checked ? "password" : "text";
             }
             // code for show password end

             document.querySelector("#login_username").addEventListener("mouseover", () =>
             {
                const userlimit = 
                `
                <p id="user_limit" class="text-white"><small>Username length limit, 5 minimum and 25 maximum.</small></p>
   
                `;
                document.querySelector("#user_limit").innerHTML = userlimit;
             });

             document.querySelector("#login_username").addEventListener("click", () =>
             {
                const userlimit = 
                `
                <p id="user_limit" class="text-white"><small>Username length limit, 5 minimum and 25 maximum.</small></p>
   
                `;
                document.querySelector("#user_limit").innerHTML = userlimit;
             });

             document.querySelector("#login_username").addEventListener("mouseout", () =>
             {
                const userlimit = 
                `
                <p id="user_limit"></p>
   
                `;
                document.querySelector("#user_limit").innerHTML = userlimit;
             });

             document.querySelector("#login_password").addEventListener("click", () =>
             {
                const userlimit = 
                `
                <p id="user_limit"></p>
   
                `;
                document.querySelector("#user_limit").innerHTML = userlimit;
             });

        </script>

        <script type="module">
           // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
            import { getFirestore, doc, getDocs, setDoc, collection, addDoc, updateDoc, deleteDoc, deleteField, onSnapshot, orderBy, query, Timestamp, where, limit} from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js';
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries
        
            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = 
            {

                apiKey: "AIzaSyAOqiiTFOyOouBjHcIC4_LTTgawe8lSR1o",
                authDomain: "weatherapp-19721.firebaseapp.com",
                projectId: "weatherapp-19721",
                storageBucket: "weatherapp-19721.appspot.com",
                messagingSenderId: "377375487089",
                appId: "1:377375487089:web:f196be7b73d41512aad7d0"

            };

            
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            
            // Initialize Cloud Firestore and get a reference to the service
            const db = getFirestore(app);
           
            
            // function for custom id
            let account_id;
            const collectionRef = collection(db, "weatherapp");
            const queryRef = query(collectionRef, orderBy("id","desc"), limit(1));

            onSnapshot(queryRef, (snapshot) => 
            {
              let last_accnt_id = null;

              snapshot.forEach((doc) => 
              {
                last_accnt_id = doc.data();
              });

              if (last_accnt_id) 
              {
                last_accnt_id.id = Number(last_accnt_id.id) + 1;
                
                const uniqueId = last_accnt_id.id;
                account_id = uniqueId;

                document.querySelector("#accountId").value = uniqueId;
              }
            });
            // function for custom id

            
            



            // code for register button
            document.querySelector("#btn_register").addEventListener("click", () => 
            {   
                const user_pass_null_modal = bootstrap.Modal.getOrCreateInstance(document.querySelector('#user_pass_null_modal'));
                const username_lenght_modal = bootstrap.Modal.getOrCreateInstance(document.querySelector('#username_lenght_modal'));


                if(document.querySelector("#login_username").value === "" || document.querySelector("#login_password").value === "")
                {
                    
                    user_pass_null_modal.show();

                }
                
               else if(document.querySelector("#login_username").value.length < 5)
                {
                    username_lenght_modal.show();
                }
                
                else
                {
                    register();
                }
                
            });
            // code for register button end

            
            // function to register a account
           async function register()
           {    
                
                let found_matching_user = false;
                const user_already_taken = bootstrap.Modal.getOrCreateInstance(document.querySelector('#user_already_taken'));
                const success_register = bootstrap.Modal.getOrCreateInstance(document.querySelector('#register_modal'));


                document.querySelector('#user_already_taken_modal_p').innerHTML = `This username (${document.querySelector("#login_username").value}) already taken.`;
                const q = query(collection(db, "weatherapp"), where("username", "==", login_username.value));

                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => 
                {
                    user_already_taken.show(); // display if no matching user was found.
                    document.querySelector("#login_username").value = ""; // clear username textbox
                    document.querySelector("#login_password").value = ""; // clear password textbox
                    found_matching_user = true;
                });
                
                if (!found_matching_user) 
                {   
                    await setDoc(doc(db, "weatherapp", accountId.value), 
                    {   
                        id: account_id,
                        username: document.querySelector("#login_username").value,
                        password: document.querySelector("#login_password").value,
                        accountmade: Timestamp.fromDate(new Date())
    
                    });

                        success_register.show();
                    
                }
            }
            // function to register a account end

           


        </script>
        <!-- Javascript -->

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" 
        crossorigin="anonymous"></script>         
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    </body>
</html>